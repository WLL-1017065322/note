多读多写用redis

多读少写用es

少读多写用mongod



403无权限，401未登录

# 日志

日志分析用的：

登录日志；



3个业务：bilog，个人中心，首页，

1 站内信， 头部dalog -徐

- bll站内信：看有没有缓存，全部未读的记录， 有没有用户id ，有没有用户key，空，在数据库查，
- 前端，未读-已读
- 没有用户key，在数据库查，在缓存加一个用户key，



2 获取用户身份， - 

3 日志：需求=>数据承载=>

- 收藏-->公共	
- 热词日志： 
- 最1 近浏览(阅读)-阅读时间，：
  - 不登录 存 localstorage：articleId，createAt,duration;setinterval5, newDate-duration ==>createAt
  - 不=>登：判断locastorage，           =>清locastorage
  - 登录：setinterval,5 请求，bll, createAt===(数据库时间), 等于更新，不等于。。
- 数图专政报告新闻,阅读时间
- 搜索的结果点击停留日志：
- 分享日志 （社交关系）必须登录，
- 登录日志，（小程序，pc端）
- 何种方式进入， 拿到url，时间排序
- 点击量（点击日志）



搜索报告：

关键词： 标题，正文，副标题，目录，名称解释，每个权值不同

排序；

重要程度，定量；





4 用户权限，用户id，-赵

5 收藏 - 凤

6 申请引用 -胡

7 相关推荐 - 王

8 相关报告 -郑

9 分享



日志需要: 

1 谁 日期 

2 目标（内容）

3 干了什么（行为）

4 1+3=> 无穷，基于123；时间线，

共同点：抽象到具体

session（id，customerid） objective （id，sid）behavior（id，oid）agent ip

点退出，删除session

有 url，有参数parma：id；key+type  sid?=apply=>sid=>oid=>oid=behavior=>oid

sid,存哪

click,score,share,keyin?

1 级 id+url;

2 级 热词param:key+type 

3 级 click....

日志，一般只写

```
初始化， 监听，
```



登录，

1 申请 sessionId

customId

2 登录



# 缓存

一个函数，两三句话；



缓存：用户用的；



浏览记录，搜索记录，去重

缓存：查数据，id,最高；

100个人点击100次

个人收藏记录，取收藏表；find( |  |  |  |)



报告的缓存

报告 id=key

- 全部{}
- 部分{没权限}

更新策略：更新到es，
- 读	
  - 在找redis
    - 有Count++，返回
    - es找
      - 有 Count++，返回,存入缓存，（注意缓存的刷新）
      - 没有，异常
- 写 es

R<redis(DAO)= bll =DAO>module

编辑器：小写多读

访问量：读写，一样，存mongo，缓存不行，丢失，不用放缓存

- 先写入缓存，符合条件，再存入mongo



个人中心的收藏：

三级页面，有

二级页面，30次，



老用户，目标：减少读写数据库次数，

前端

​	{}

​	新增移除，

​	排序，生成SHA1，比对，

​	不一样

缓存

​	SHA1（custom）

​	



数据库

​	全部

​	放客户端localstorage?新增，移除？问题多个客户端？

​	排序，生成SHA1，比对，



缓存一直变

a  b

打 打

a1 a1

a2 b2



首页缓存：

三类：公众关心的热词；通用

个人关心：历史记录和标签搜索 ；独立出去；

官方推荐的东西：新报告；通用 ；有新，更新；排序，取前n；



怎么来：

怎么存：定时器更新；没半天



数图专政报告新闻：





关键词缓存：

啤酒：key；90条数据：value



1 有新数据，重新缓存，全部干掉

2 

k1 [v1]

k2 [v2]

k3 [v3]



更新策略：





站内信：key：value

​				系统  	 个人 ；一条好；站内信：数据结构：内容，过期时间，创建时间

​															用户： id,cid,信id =>有已读，无未读

- 已登录：
  - key cid, 放到后端，策略，curstiom，有key，空值：无消息；无key：1 刚注册，2 缓存空的，数据库 3 查数据库没key，加上
- 未   [n],1 按天自动更新，失效，从缓存把失效的移走 2 发一次失效，

个人信息：头像信息，不用缓存；

轮播图：缓存有找缓存，缓存没有，找数据库，加入缓存。







# 报告模型改了

brief：

es: 7.0，英文

es的格式，写成 article里的格式， 控制台执行

mongo的内容部分es

es的数据来自编辑器，







# 所有二级页面的缓存问题：

搜索用一种缓存策略，二级页面的不是搜索的内容：报告，新闻

只管参数和url

客户提供信息：

- 参数
- 目标

​	===>唯一

放到bll层xxx

用url：？aaa&p1&p2     作为key

page:2000 合法，为空

abc=? abc不存在，bll层不处理

放到router层:更通用

router =>redis     url中间件，1 取param(path)，所有小写2 排序，3 base64 encode（转义）=>key

​			     ||

​			  	V

​			bll => es







# 解决的公共问题

1 用户身份读取（中间）

2 用户身份验证（中间）

3 访问量（阅读量的写和读）：赵

4 相关推荐：胡铁平

5 阅读记录（最）：

6 日志：

7 单一类缓存读写

8 二级页面缓存：张

9 收藏：收藏的心，数据不需要模型，从localstorgae取；凤

站内信通用部分，中间件:徐







# 图片，精品图，不能看

高清地址抹掉

路由中转

动态路径



# 几种图片上传：

1 各头图（报告/article）

2 图说，slide

3 头像（个人，厂牌，专家）



oss:/xxxxx/lead_www/

年(4)月(2)日(2)/文件名.jpg :1 2 



oss:/xxxxx/lead_www/

avator/xxxxxxxxx

  