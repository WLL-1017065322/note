# 开发摘要

## 获取轮播图

- Model
  {
    <!-- 轮播图片地址 -->
    imageUrl: String
    <!-- 轮播链接地址 -->
    url: String
    <!-- 轮播图排序code default: 0 -->
    sortCode: Number
    <!-- 是否禁用 default: true -->
    disabled: Boolean
  }

- Router层:
  - 调用BLL层获取轮播图方法

- BLL层:
  - 方法参数: 空
  - 过程:
    1. 通过key去找对应的value
       1. 如果缓存中有轮播图的数据, 获取后直接返回
       2. 如果获取不到, 在ES数据库中查询, 根据最新创建时间和不是禁用状态的获取轮播图数据, 根据sortCode进行排序
       3. 获取后将数据作为value值存入redis缓存中, 将结果返回

- 返回结果: data: [{}, {}, {}]

## 报告加速

- Model
{
  <!-- 报告Id -->
  briefId: ObjectId
  <!-- 客户Id -->
  customerId: ObjectId
  <!-- 加速价格 -->
  price: Number
}

- 前端
  1. 点击报告加速, 判断是否登陆
    1.1 如果登录, 获取到报告id进行页面跳转
    1.2 如果没有登录则跳转到登录页

- 后端
  - Router层
    - 获取请求参数briefId, 调用BLL层 报告加速 方法

  - BLL层
    - 方法参数: briefId 必填, customerId 必填
    - 过程:
      1. 判断参数是否是合法的briefId值和customerId值, 如果不合法, 返回参数错误
      2. 参数合法, 则通过briefId获取到报告
         1. 判断该报告是否是即将发布报告, 如果不是即将发布, 抛出异常对象：{errCode: 404, msg: '该报告未找到'}
         2. 如果是即将发布, 获取到该报告加速的价格
      3. 根据加速价格调用生成二维码订单方法
      4. 渲染到前端页面
      PS: 支付订单调用统一支付接口

## 发布提醒 admin系统提醒

- Model
  {
    <!-- 报告Id -->
    briefId: ObjectId
    <!-- 客户Id -->
    customerId: ObjectId
    <!-- 是否发送 -->
    send: Boolean
    <!-- 发送方式 -->
    sendMode: String
  }

- 前端
  1. 点击发布提醒, 判断是否登陆
     1. 如果登录, 获取到报告的id进行异步请求
     2. 如果没有登录则跳转到登录页

- 接口
  - 名称: /remind
  - 方法: POST
  - 请求参数: briefId

- 后端
  - Router层
    - 获取报告briefId、用户Id, 调用Bll层方法
  - BLL层
    - 方法参数: userId
               briefId(报告id) 必填
    - 过程:
      1. 判断是否是合法的briefId值, 如果不合法, 返回参数错误
      2. 参数合法, 首先查询mongo数据库查看是否存在该条数据
         1. 如果不存在, 则将该条数据插入数据库, 成功后将结果返回
         2. 如果存在, 则在mongo数据库通过用户id和报告id将remind字段更新成相反的结果
         3. 操作完成后将结果返回

- 返回结果 成功: { errCode: 0, msg: 'success' }
          失败: { errCode:, msg: 'error' }

## 用户身份验证

- Router层:
  1. 判断用户的req.cookie.token是否携带了token, 如果没有携带token, 则直接放行,
  2. 如果携带了token, 则通过jwt.verify(token, global.jwtSecretKey) 判断token是否合法
    2.1 如果验证通过, 则对用户信息通过jwt.decode(token)进行解密, 获取到用户信息, 放入到req.user里, 放行
    2.2 如果不通过, 则返回提示用户身份不合法

## 首页无用户缓存

- 前端
  - 用户没有携带用户身份访问了首页

- 后端

  - Router层
    - 判断用户是否有用户身份
      1. 用户没有携带用户身份, 调用BLL层没有用户身份的方法
        PS: 这里需要判断用户是否有身份, 有无身份调用不同BLL层方法

  - BLL层
    1. 读取缓存中是否有 无身份的首页缓存
      1.1 有缓存, 则获取缓存直接返回
      1.2 如果没有缓存
        1.2.1 通过ES搜索 数图专政报告(普通、精品、即将上架)
              依据热词和推荐内容规则查询数据 匹配词权重的规则生成搜索条件查询
        1.2.2 字段匹配规则和排序依据以下顺序
               图说: 名称、段落、文章
               数说: 标题、行业、描述、产品名称、产品行业
               政策说: 标题、纯文本
               专家说: 专家姓名、行业、主题、公司、权威、内容
               新闻: 标题、行业、标签、摘要、内容
               报告: 类型 ———— 精品: 标题、副标题、行业、标签、目录、名词、名词解释、段落、图片名称
                         |___ 普通: 标题、副标题、行业、标签、目录、名词、名词解释、段落、图片名称
                         |___ 即将发布: 标题、副标题、行业、标签、目录、名词、名词解释
        1.2.3 获取数据后将即将发布的剩余天数数据重新组成为一个数据
        1.2.4 根据最高次数排序获取搜索热词
        1.2.5 生成数据, 存入缓存, 返回数据

## 搜索缓存

- 前端
  - 用户访问搜索页

- 后端

  - Router层
    - 获取请求的URL地址, 将地址传入到BLL层

  - BLL层
    - 方法参数: URL
    - 过程:
      1. 解析URL后面的参数, 将URL参数序列化、小写、base64 enCode生成
      2. 把生成好的数据作为key, 读取缓存, 查看缓存中是否有该key对应的value值
        1.1 如果有, 则读取缓存中的数据直接返回
        1.2 如果缓存中没有该数据
          1.2.1 解析URL里的参数, 生成查询条件, 通过ES搜索数据(复用首页搜索规则)
                PS: 如果参数合法则处理, 如果参数不合法则不将不合法的参数生成查询条件
          1.2.2 获取到搜索结果后, 将参数序列化、小写、base64 enCode后存入缓存
          1.2.3 将获取到的数据返回

  - 返回结果: 成功: 标准分页返回对象
             失败: 错误结果

## 详情缓存

- 前端
  - 用户访问二级详情页
    1. 如果是报告的二级详情页
       1. 没有登录, 跳转到登录
       2. 登录, 进行数据同步请求
    2. 如果访问的是新闻、专家说、数说、图说、政策说的详情页
       1. 进行数据同步请求

- 后端
  - Router层
    - 获取请求的ID, 将ID传入到BLL层

  - BLL层
    - 方法参数: id 必填
    - 过程:
      1. 判断参数是否是合法的id值, 如果不合法, 返回参数错误, 如果没有该数据, 则返回404
      2. 如果访问的是报告的详情
         1. 判断报告是否是限免, 如果是限免报告, 则获取缓存中的数据
            1. 如果缓存中有该报告的数据, 返回该报告数据
            2. 如果缓存中没有该报告的数据
               1. ES搜索该数据
                  1. 通过ES查询详情数据, 如果没有查询到数据, 返回404
                  2. 查询到数据将数据存储到缓存, key为id, value为查询到的内容, 将查询到的数据返回
         2. 如果该报告不是限免报告
            1. 传递customerId和报告Id调用 用户是否有权限看 方法
               1. 如果用户有权限看该报告, 查看缓存中是否有该报告数据
                  1. 缓存中有该数据, 读取后, 返回数据
                  2. 缓存中没有该报告数据
                     1. ES搜索该数据
                        1. 通过ES查询详情数据, 如果没有查询到数据, 返回404
                        2. 查询到数据将数据存储到缓存, key为id, value为查询到的内容, 将查询到的数据返回
      3. 如果访问的是新闻或专家说
         1. 从缓存中获取该数据
            1. 如果缓存中有该数据, 获取后返回
            2. 缓存中没有该数据
               1. ES搜索该数据
                  1. 通过ES查询详情数据, 如果没有查询到数据, 返回404
                  2. 查询到数据将数据存储到缓存, key为id, value为查询到的内容, 将查询到的数据返回
      4. 如果访问的是政策说或图说
         1. 查看政策说或图说的关联报告Id没有和报告关联或是否包含了不是精品的报告
            1. 如果没有和报告关联, 或者包含了不是精品的报告, 则获取缓存中的该数据
               1. 如果缓存中包含了该数据, 获取后返回
               2. 如果缓存中没有该数据
                  1. ES搜索该数据
                     1. 通过ES查询详情数据, 如果没有查询到数据, 返回404
                     2. 查询到数据将数据存储到缓存, key为id, value为查询到的内容, 将查询到的数据返回
            2. 如果没有包含
               1. 则 传递customerId和报告Id调用 用户是否有权限看 方法
                  1. 如果有权限, 则去缓存中获取该数据
                     1. 如果缓存中有该数据, 获取后返回
                     2. 缓存中没有该数据
                        1. ES搜索该数据
                           1. 通过ES查询详情数据, 如果没有查询到数据, 返回404
                           2. 查询到数据将数据存储到缓存, key为id, value为查询到的内容, 将查询到的数据返回
                  2. 如果没有权限, 则不返回数据
      5. 如果访问的是数说
         1. 查看数说关联报告Id没有和报告关联或是否包含了不是精品的报告
            1. 如果没有和报告关联, 或者包含了不是精品的报告, 则获取缓存中的该数据
               1. 如果缓存中包含了该数据, 获取后返回
               2. 如果缓存中没有该数据
                  1. ES搜索该数据
                     1. 通过ES查询详情数据, 如果没有查询到数据, 返回404
                     2. 查询到数据将数据存储到缓存, key为id, value为查询到的内容, 将查询到的数据返回
               3. 判断用户是否登录
                  1. 登录调用显示数据的页面
                  2. 没有登录调用不显示数据的页面
            2. 如果没有包含
               1. 则 传递customerId和报告Id调用 用户是否有权限看 方法
                  1. 如果有权限, 则去缓存中获取该数据
                     1. 如果缓存中有该数据, 获取后返回
                     2. 缓存中没有该数据
                        1. ES搜索该数据
                           1. 通过ES查询详情数据, 如果没有查询到数据, 返回404
                           2. 查询到数据将数据存储到缓存, key为id, value为查询到的内容, 将查询到的数据返回
                  2. 如果没有权限, 则不返回数据
