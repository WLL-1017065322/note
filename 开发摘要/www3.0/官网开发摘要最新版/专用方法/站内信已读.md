<!-- 作者：徐斌 -->
<!-- 日期：2019-12-09 -->

# 站内信

## 个人中心站内信—一键全部已读-异步

1、前端

```
操作：用户点击个人中心站内信的一键已读按钮
请求：post（user/readMessages）
请求参数：{
    messageId： String， 站内信id，可不填，填表示用于单条已读操作
}
处理：如果成功{code：0，msg: 'success'},表示一键已读操作成功，所有通知的状态用dom操作已读，并隐藏单条已读按钮。同时隐藏         头部站内信小红点，隐藏已读操作按钮
    如果返回{code： 1， msg：String 错误原因}提示用户操作失败原因
```

2、后端

```
请求方法：post
router： user/readMessages
model：SysMail、UserMailLog
bll：
    1. 获取用户已读通知
    2、获取有效的系统通知
        2.1 判断用户记录中是否存在该系统通知id
            2.1.1 如果不存在，说明该条系统通知未读
                2.1.1.1 将该系统通知新增到用户已读记录表中
                 2.1.1.2 清除用户已读缓存，将更新的数据库的已读记录存入缓存
             2.1.2 如果存在，则该通知已读，继续下一条，从新走2.1
返回值：如果成功，返回对象{code： 0， msg： ‘success'}
        如果失败，返回对象{code： 1， msg：String 错误原因}
```

## 个人中心站内信-单条已读-异步

1、前端

```
操作：用户点击个人中心站内信的单条按钮，首页站内信dialog中点击某一条进入个人中心站内信页面(带mailId跳转)
请求：post（user/readMail）
请求参数：{
    MailId： String， 站内信id，用于单条已读操作
}
处理：如果{code: 0, msg: 'success'}，dom操作该条数据状态已读，并隐藏该条已读按钮
    如果{code： 1， msg：String 错误原因} 提示用户失败原因
```

2、后端

```
请求方法：post
router： user/readMessages
参数：messageId
model：SysMail、UserMailLog
bll：
    参数： messageId
    过程：
        1. 获取用户已读通知
        2、获取有效的系统通知
            2.1 判断用户记录中是否存在该系统通知id
                2.1.1 如果不存在，说明该条系统通知未读
                    2.1.1.1 将该系统通知新增到用户已读记录表中
                    2.1.1.2 清除用户已读缓存，将更新的数据库的已读记录存入缓存
                2.1.2 如果存在，则该通知已读 return
返回值：如果成功，返回对象{code： 0， msg： ‘success'}
        如果失败，返回对象{code： 1， msg：String 错误原因}
```