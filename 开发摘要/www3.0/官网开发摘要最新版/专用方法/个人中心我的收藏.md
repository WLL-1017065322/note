<!-- 作者：胡铁平
日期：2019-12-9 -->

# 个人中心

- 中间件处理token，检验用户身份合法性

## 最近收藏

### 最近收藏前端

- 操作： 点击个人中心左下角导航栏的“我的收藏”，跳转到个人收藏列表
- 请求地址： user/mycollection

### 最近收藏后端（同步渲染） ROUTER

- 请求方法：GET
- 参数：(searchType, currentPage)
- 路由： user/mycollection
    1. 调用getMyCollection(searchType, currentPage = 1)
    2. 根据返回结果
      1. 成功：有返回否则渲染最近收藏页面
      2. 异常：渲染错误页面；请求资源不存在渲染404页面；其他异常渲染500页面

- model：customer、favorite

#### 最近收藏获取业务逻辑 BLL

参数：

- searchType：String格式，收藏记录类型(默认精品报告)，必填
- currentPage：Number格式，当前页，选填,不填写默认为1

过程

  1. 中间件判断用户权限与身份
  2. 根据用户id查询用户信息
  3. 根据用户id和type查找收藏记录
     1. 如果存在收藏记录，返回收藏记录的（type）Id数组[]
     2. 如果不存在收藏记录
        1. 查询到的收藏记录为空，返回空数组（用户暂时没有收藏记录，正常，省去查ES数据库步骤）
        2. 捕获到异常抛出异常对象：DB_ERR: [2000, '数据库操作异常']（数据库错误异常）
  4. 根据步骤3结果，如果返回数组为空返回空数组，否则往下执行
     1. 通过收藏记录的（type）id数组查找es数据库
        1. 如果查到收藏记录，返回收藏记录数组[{favorite}...]
        2. 如果未查到收藏记录
           1. 查找到的收藏记录列表为空，返回空数组
              1. 查找到的报告列表为空可能是mongo和ES数据库数据没有同步，导致（type）Id在ES中找不到对应的数据
           2. 捕获到异常抛出异常对象：DB_ERR: [2000, '数据库操作异常']
  5. 返回获取到的收藏列表

返回数据

- 成功：[{收藏对象}...], {user}, {标准分页对象}
  - [{收藏对象}...]：最近收藏对象数组， user：用户信息
- 失败：错误信息
